source /usr/local/opt/chruby/share/chruby/chruby.sh
source /usr/local/opt/gem_home/share/gem_home/gem_home.sh

# Project-specific Vim configuration, experimental
add_extra_vimrc() {
  local extravim="$(find_up .vimrc)"
  if [ -n "$extravim" ]; then
    echo "Adding extra .vimrc: ${extravim}"
    path_add EXTRA_VIM $extravim
  fi
}

# use ruby [version]
use_ruby() {
  local ver=$1

  if [[ -z $ver ]] && [[ -f .ruby-version ]]; then
    ver=$(cat .ruby-version)
  fi

  if [[ -z $ver ]]; then
    echo "Unknown ruby version $ver"
    exit 1
  fi

  chruby $ver
}

# use gemset
use_gemset() {
  local dir="$HOME/.config/gemsets/$1"
  if [[ -d $dir ]]; then
    gem_home $dir
  else
    echo "Unknown gemset $1"
    exit 1
  fi
}

###
# Simplified gem_home implementation for working with local gems.
###

function use_local_gems()
{
  mkdir -p "$1" && pushd "$1" >/dev/null || return 1
  local ruby_engine ruby_version gem_dir

  eval "$(ruby - <<EOF
puts "ruby_engine=#{defined?(RUBY_ENGINE) ? RUBY_ENGINE : 'ruby'};"
puts "ruby_version=#{RUBY_VERSION};"
EOF
)"
  gem_dir="$PWD/$ruby_engine/$ruby_version"

  [[ "$GEM_HOME" == "$gem_dir" ]] && return

  export GEM_HOME="$gem_dir"
  export GEM_PATH="$gem_dir${GEM_PATH:+:}$GEM_PATH"
  export PATH="$gem_dir/bin${PATH:+:}$PATH"

  popd >/dev/null
}
